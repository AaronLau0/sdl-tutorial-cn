<!DOCTYPE html>
<html>
 <head> 
  <meta charset="utf-8" /> 
  <title>第2课 - 优化表面的加载和Blit &middot; SDL中文教程</title> 
  <meta name="viewport" content="width=device-width, initial-scale=1.0" /> 
  <meta name="description" content="" /> 
  <meta name="author" content="" /> 
  <!-- Le styles --> 
  <link href="../../assets/css/bootstrap.css" rel="stylesheet" /> 
  <link href="../../assets/css/bootstrap-responsive.css" rel="stylesheet" /> 
  <link href="../../assets/css/docs.css" rel="stylesheet" /> 
  <link href="../../assets/js/google-code-prettify/prettify.css" rel="stylesheet" /> 
  <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements --> 
  <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]--> 
  <!-- Le fav and touch icons --> 
  <link rel="shortcut icon" href="../../assets/ico/favicon.ico" /> 
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../../assets/ico/apple-touch-icon-144-precomposed.png" /> 
  <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../../assets/ico/apple-touch-icon-114-precomposed.png" /> 
  <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../../assets/ico/apple-touch-icon-72-precomposed.png" /> 
  <link rel="apple-touch-icon-precomposed" href="../../assets/ico/apple-touch-icon-57-precomposed.png" /> 
 </head> 
 <body data-spy="scroll" data-target=".subnav" data-offset="50">
   ﻿ 
  <!-- Navbar
    ================================================== --> 
  <div class="navbar navbar-fixed-top"> 
   <div class="navbar-inner"> 
    <div class="container"> 
     <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> 
     <a class="brand" href="../../index.html">SDL中文教程</a> 
     <div class="nav-collapse collapse"> 
      <ul class="nav"> 
       <li class=""><a href="../../index.html">简介</a></li> 
       <li class=""><a href="../../contents.html">目录</a></li> 
       <li class=""><a href="../../about.html">关于</a></li> 
      </ul> 
     </div> 
    </div> 
   </div> 
  </div> 
  <div class="container"> 
   <div class="row"> 
    <div class="span10 offset1"> 
     <h1 align="center" id="content_title">第2课 - 优化表面的加载和Blit</h1> 
     <br /> 
     <p align="center"> <span class="label label-info">更新时间：2012年6月21日</span> </p> 
     <ul class="quick-links"> 
      <li><a class="btn btn-info" target="_blank" id="origin_link" href="http://lazyfoo.net/SDL_tutorials/lesson02/index.php">原文链接</a></li> 
      <li><a class="btn" href="../lesson01/index.html" id="prev_link">上一课</a></li> 
      <li><a class="btn" href="../lesson03/index.html" id="next_link">下一课</a></li> 
     </ul> 
     <hr /> 
    </div> 
   </div> 
   <!-- Main contents start from here --> 
   <div class="row"> 
    <div class="well span10 offset1"> 
     <div class="alert alert-warning"> 
      <strong>译者注：</strong>本页面还未完成翻译，如有兴趣参与本项目，请 
      <strong><a href="../../about.html">联系我</a></strong>！ 
     </div> 
     <div class="content">
      <div class="tutPreface"> 
       <h1 class="tutHead">Optimized Surface Loading and Blitting</h1> 
       <div class="tutImg"> 
        <img src="preview.jpg" /> 
       </div> 
       <h6>Last Updated 12/28/09</h6> Now that you got an image on the screen in 
       <a class="tutLink" href="../lesson01/index2.php">part 2 of the last tutorial</a>, it's time do your surface loading and blitting in a more efficient way. 
      </div> 
      <pre class="tutCode prettyprint linenums:1 lang-cpp">//The headers
#include &quot;SDL/SDL.h&quot;
#include &lt;string&gt;
</pre> 
      <div class="tutText">
        Here are our headers for this program. 
       <br /> 
       <br /> SDL.h is included because obviously we're going to need SDL's functions. 
       <br /> 
       <br /> The string header is used because ... eh I just like std::string over char* 
       <br /> 
      </div> 
      <pre class="tutCode prettyprint linenums:4 lang-cpp">//The attributes of the screen
const int SCREEN_WIDTH = 640;
const int SCREEN_HEIGHT = 480;
const int SCREEN_BPP = 32;
</pre> 
      <div class="tutText">
        Here we have the various attributes of the screen. 
       <br /> 
       <br /> I'm pretty sure you can figure out what SCREEN_WIDTH and SCREEN_HEIGHT are. SCREEN_BPP is the bits per-pixel. In all of the tutorials, 32-bit color will be used. 
      </div> 
      <pre class="tutCode prettyprint linenums:8 lang-cpp">//The surfaces that will be used
SDL_Surface *message = NULL;
SDL_Surface *background = NULL;
SDL_Surface *screen = NULL;
</pre> 
      <div class="tutText">
        These are the three images that are going to be used. 
       <br /> 
       <br /> &quot;background&quot; is obviously going to be the background image, &quot;message&quot; is the bitmap that says &quot;Hello&quot; and &quot;screen&quot; is obviously the screen. 
       <br /> 
       <br /> Remember: its a good idea to always set your pointers to NULL if they're not pointing to anything. 
      </div> 
      <pre class="tutCode prettyprint linenums:12 lang-cpp">SDL_Surface *load_image( std::string filename ) 
{
    //Temporary storage for the image that's loaded
    SDL_Surface* loadedImage = NULL;
    
    //The optimized image that will be used
    SDL_Surface* optimizedImage = NULL;
</pre> 
      <div class="tutText">
        Here we have our image loading function. 
       <br /> 
       <br /> What this function does is load the image, then returns a pointer to the optimized version of the loaded image. 
       <br /> 
       <br /> The argument &quot;filename&quot; is the path of the image to be loaded. &quot;loadedImage&quot; is the surface we get when the image is loaded. &quot;optimizedImage&quot; is the surface that is going to be used. 
      </div> 
      <pre class="tutCode prettyprint linenums:19 lang-cpp">    //Load the image
    loadedImage = SDL_LoadBMP( filename.c_str() );
</pre> 
      <div class="tutText">
        First the image is loaded using SDL_LoadBMP(). 
       <br /> 
       <br /> But it shouldn't be used immediately because the bitmap is 24-bit. The screen is 32-bit and it's not a good idea to blit a surface onto another surface that is a different format because SDL will have to change the format on the fly which causes slow down. 
       <br /> 
      </div> 
      <pre class="tutCode prettyprint linenums:21 lang-cpp">    //If nothing went wrong in loading the image
    if( loadedImage != NULL )
    {
        //Create an optimized image
        optimizedImage = SDL_DisplayFormat( loadedImage );
        
        //Free the old image
        SDL_FreeSurface( loadedImage );
    }
</pre> 
      <div class="tutText">
        Next we check if the image was loaded properly. If there was an error, loadedImage will be NULL. 
       <br /> 
       <br /> If the image loaded fine, SDL_DisplayFormat() is called which creates a new version of &quot;loadedImage&quot; in the same format as the screen. The reason we do this is because when you try to stick one surface onto another one of a different format, SDL converts the surface so they're the same format. 
       <br /> 
       <br /> Creating the converted surface every time you blit wastes processing power which costs you speed. Because we convert the surface when we load it, when you want to apply the surface to the screen, the surface is already the same format as the screen. Now SDL won't have to convert it on the fly. 
       <br /> 
       <br /> So now we have 2 surfaces, the old loaded image and the new optimized image. 
       <br /> 
       <div class="tutImg"> 
        <img src="displayformat.jpg" /> 
       </div> SDL_DisplayFormat() created a new optimized surface but didn't get rid of the old one. 
       <br /> 
       <br /> So we call SDL_FreeSurface() to get rid of the old loaded image. 
       <br /> 
       <div class="tutImg"> 
        <img src="freesurface.jpg" /> 
       </div> 
      </div> 
      <pre class="tutCode prettyprint linenums:30 lang-cpp">    //Return the optimized image
    return optimizedImage;
}
</pre> 
      <div class="tutText">
        Then the newly made optimized version of the loaded image is returned. 
      </div> 
      <pre class="tutCode prettyprint linenums:33 lang-cpp">void apply_surface( int x, int y, SDL_Surface* source, SDL_Surface* destination )
{
    //Make a temporary rectangle to hold the offsets
    SDL_Rect offset;
    
    //Give the offsets to the rectangle
    offset.x = x;
    offset.y = y;
</pre> 
      <div class="tutText">
        Here we have our surface blitting function. 
       <br /> 
       <br /> It takes in the coordinates of where you want to blit the surface, the surface you're going to blit and the surface you're going to blit it to. 
       <br /> 
       <br /> First we take the offsets and put them inside an SDL_Rect. We do this because SDL_BlitSurface() only accepts the offsets inside of an SDL_Rect. 
       <br /> 
       <br /> An SDL_Rect is a data type that represents a rectangle. It has four members representing the X and Y offsets, the width and the height of a rectangle. Here we're only concerned about x and y data members. 
      </div> 
      <pre class="tutCode prettyprint linenums:41 lang-cpp">    //Blit the surface
    SDL_BlitSurface( source, NULL, destination, &amp;offset );
}
</pre> 
      <div class="tutText">
        Now we actually blit the surface using SDL_BlitSurface(). 
       <br /> 
       <br /> The first argument is the surface we're using. 
       <br /> Don't worry about the second argument, we'll just set it to NULL for now. 
       <br /> The third argument is the surface we're going to blit on to. 
       <br /> The fourth argument holds the offsets to where on the destination the source is going to be applied. 
      </div> 
      <pre class="tutCode prettyprint linenums:44 lang-cpp">int main( int argc, char* args[] )
{
</pre> 
      <div class="tutText">
        Now we start the main function. 
       <br /> 
       <br /> When using SDL, you should always use: 
       <br /> int main( int argc, char* args[] ) 
       <br /> 
       <br /> or 
       <br /> 
       <br /> int main( int argc, char** args ) 
       <br /> 
       <br /> Using int main(), void main(), or any other kind won't work. 
      </div> 
      <pre class="tutCode prettyprint linenums:46 lang-cpp">    //Initialize all SDL subsystems
    if( SDL_Init( SDL_INIT_EVERYTHING ) == -1 )
    {
        return 1;    
    }
</pre> 
      <div class="tutText">
        Here we start up SDL using SDL_Init(). 
       <br /> 
       <br /> We give SDL_Init() SDL_INIT_EVERYTHING, which starts up every SDL subsystem. SDL subsystems are things like the video, audio, timers, etc that are the individual engine components used to make a game. 
       <br /> 
       <br /> We're not going to use every subsystem but it's not going to hurt us if they're initialized anyway. 
       <br /> 
       <br /> If SDL can't initialize, it returns -1. In this case we handle the error by returning 1, which will end the program. 
      </div> 
      <pre class="tutCode prettyprint linenums:51 lang-cpp">    //Set up the screen
    screen = SDL_SetVideoMode( SCREEN_WIDTH, SCREEN_HEIGHT, SCREEN_BPP, SDL_SWSURFACE );
</pre> 
      <div class="tutText">
        Now it's time to make our window and get a pointer to the window's surface so we can blit images to the screen. 
       <br /> 
       <br /> You already know what the first 3 arguments do. The fourth argument creates the screen surface in system memory. 
      </div> 
      <pre class="tutCode prettyprint linenums:53 lang-cpp">    //If there was an error in setting up the screen
    if( screen == NULL )
    {
        return 1;    
    }
</pre> 
      <div class="tutText">
        If there was a problem in making the screen pop up, screen will be set to NULL. 
      </div> 
      <pre class="tutCode prettyprint linenums:58 lang-cpp">    //Set the window caption
    SDL_WM_SetCaption( &quot;Hello World&quot;, NULL );
</pre> 
      <div class="tutText">
        Here the caption is set to &quot;Hello World&quot;. 
       <br /> 
       <br /> The caption is this part of the window: 
       <br /> 
       <div class="tutImg"> 
        <img src="caption.jpg" /> 
       </div> 
      </div> 
      <pre class="tutCode prettyprint linenums:60 lang-cpp">    //Load the images
    message = load_image( &quot;hello.bmp&quot; );
    background = load_image( &quot;background.bmp&quot; );
</pre> 
      <div class="tutText">
        Now the images are loaded using the image loading function we made. 
      </div> 
      <pre class="tutCode prettyprint linenums:63 lang-cpp">    //Apply the background to the screen
    apply_surface( 0, 0, background, screen );
</pre> 
      <div class="tutText">
        Now it's time to apply the background with the function we made. 
       <br /> 
       <br /> Before we blitted the background, the screen looked like this: 
       <br /> 
       <div class="tutImg"> 
        <img src="blank.jpg" /> 
       </div> 
       <br /> But now that we blitted the background image, the screen looks like this in memory: 
       <br /> 
       <div class="tutImg"> 
        <img src="background.jpg" /> 
       </div> 
       <br /> When you blit, you copy the pixels from one surface onto another. So now the screen has our background image in the top left corner, but we want to fill up the entire screen. Does that mean we have to load the background image 3 more times? 
      </div> 
      <pre class="tutCode prettyprint linenums:65 lang-cpp">    apply_surface( 320, 0, background, screen );
    apply_surface( 0, 240, background, screen );
    apply_surface( 320, 240, background, screen );</pre> 
      <div class="tutText">
        Nope. We can just blit the same surface 3 more times. 
      </div> 
      <pre class="tutCode prettyprint linenums:68 lang-cpp">    //Apply the message to the screen
    apply_surface( 180, 140, message, screen );
</pre> 
      <div class="tutText">
        Now we're going to apply the message surface onto the screen at x offset 180 and y offset 140. 
       <br /> 
       <br /> The thing is SDL coordinate system doesn't work like this: 
       <br /> 
       <div class="tutImg"> 
        <img src="cartesian.jpg" /> 
       </div> 
       <br /> SDL's coordinate system works like this: 
       <br /> 
       <div class="tutImg"> 
        <img src="sdlcoord.jpg" /> 
       </div> So the origin (0,0) is at the top left corner instead of the bottom left. 
       <br /> 
       <br /> So when you blit the message surface, it's going to blit it 180 pixels right, and 140 pixels down from the origin in the top left corner: 
       <br /> 
       <div class="tutImg"> 
        <img src="coorddemo.jpg" /> 
       </div> 
       <br /> SDL's coordinate system is awkward at first but you'll get used to it. 
      </div> 
      <pre class="tutCode prettyprint linenums:70 lang-cpp">    //Update the screen
    if( SDL_Flip( screen ) == -1 )
    {
        return 1;    
    }
</pre> 
      <div class="tutText">
        Even though we have applied our surfaces, the screen we see is still blank. 
       <br /> 
       <br /> Now we have to update the screen using SDL_Flip() so that the screen surface we have in memory matches the one shown on the screen. 
       <br /> 
       <br /> If there's an error it will return -1. 
       <br /> 
      </div> 
      <pre class="tutCode prettyprint linenums:75 lang-cpp">    //Wait 2 seconds
    SDL_Delay( 2000 );
</pre> 
      <div class="tutText">
        We call SDL_Delay() so that the window doesn't just flash on the screen for a split second. SDL_Delay() accepts time in milliseconds, or 1/1000 of a second. 
       <br /> 
       <br /> So the window will stay up for 2000/1000 of a second or 2 seconds. 
      </div> 
      <pre class="tutCode prettyprint linenums:77 lang-cpp">    //Free the surfaces
    SDL_FreeSurface( message );
    SDL_FreeSurface( background );
    
    //Quit SDL
    SDL_Quit();
    
    //Return
    return 0;
}
</pre> 
      <div class="tutText">
        Now we do the end of the program clean up. 
       <br /> 
       <br /> SDL_FreeSurface() is used to get rid of the surfaces we loaded since we're not using them anymore. If we don't free the memory we used, we will cause a memory leak. 
       <br /> 
       <br /> Then SDL_Quit() is called to quit SDL. Then we return 0, ending the program. 
       <br /> 
       <br /> You may be asking yourself &quot;why aren't we freeing the screen surface?&quot;. Don't worry. SDL_Quit() will take care of that for us. 
      </div> 
      <div class="tutText">
        If you run the program and the images don't show up or the window flashes for a second and you find in stderr.txt: 
       <br /> Fatal signal: Segmentation Fault (SDL Parachute Deployed) 
       <br /> 
       <br /> It's because the program tried to access memory it wasn't supposed to. Odds are it's because it tried to access NULL when apply_surface() was called. This means you need to make sure the bitmap files are in the same directory as the program. 
       <br /> 
       <br /> If the window pops up and the image doesn't show up, again make sure the bitmaps are in the same folder as the program or in the project directory. 
       <br /> 
       <br /> If you're using Visual Studio and the compiler complains about 
       <b>'SDL/SDL.h': No such file or directory</b>, go to the top of the source code and make sure it says 
       <b>#include &quot;SDL.h&quot;</b>. 
       <br /> 
       <br /> Also if you're using Visual Studio and you get the error 
       <b>&quot;The application failed to start because the application configuration is incorrect. Reinstalling the application may fix this problem.&quot;</b>, it's because you don't have the service pack update installed. 
       <a class="tutLink" href="../lesson01/windows/vcsetup/index.php">Do not forget to have the latest version of your compiler/IDE with the service pack update for your compiler/IDE or SDL will not work with Visual Studio</a>. 
      </div> 
      <div class="tutFooter">
        Download the media and source code for this tutorial 
       <a class="tutLink" href="../../downloads/index.php@file=SDLTut_lesson02">here</a>. 
       <br /> 
       <br /> 
       <a class="leftNav" href="../lesson01/index2.php">Previous Tutorial</a> 
       <a class="rightNav" href="../lesson03/index.php">Next Tutorial</a> 
       <br /> 
      </div>
     </div> 
    </div> 
   </div> 
   <!-- End of main contents--> 
   <!-- Footer
      ================================================== --> 
   <footer class="footer"> 
    <p class="pull-right"> <a href="#">返回页首</a> </p> 
    <p> 翻译及网站编辑：<a href="../../about.html">tjumyk</a>.<br /> 由来自Twitter的<a href="http://getbootstrap.com" target="_blank">Bootstrap </a>强力驱动. </p> 
    <p> 所有内容采用<a target="_blank" href="http://creativecommons.org/licenses/by/3.0/">CC BY 3.0</a>许可. </p> 
    <p> 引用图标来自<a target="_blank" href="http://glyphicons.com">Glyphicons Free</a>, 采用 <a target="_blank" href="http://creativecommons.org/licenses/by/3.0/">CC BY 3.0</a>许可. </p> 
   </footer> 
  </div> 
  <!-- /container --> 
  <!-- Le javascript
    ================================================== --> 
  <!-- Placed at the end of the document so the pages load faster --> 
  <script src="../../assets/js/jquery.js"></script> 
  <script src="../../assets/js/google-code-prettify/prettify.js"></script> 
  <script src="../../assets/js/bootstrap-transition.js"></script> 
  <script src="../../assets/js/bootstrap-alert.js"></script> 
  <script src="../../assets/js/bootstrap-modal.js"></script> 
  <script src="../../assets/js/bootstrap-dropdown.js"></script> 
  <script src="../../assets/js/bootstrap-scrollspy.js"></script> 
  <script src="../../assets/js/bootstrap-tab.js"></script> 
  <script src="../../assets/js/bootstrap-tooltip.js"></script> 
  <script src="../../assets/js/bootstrap-popover.js"></script> 
  <script src="../../assets/js/bootstrap-button.js"></script> 
  <script src="../../assets/js/bootstrap-collapse.js"></script> 
  <script src="../../assets/js/bootstrap-carousel.js"></script> 
  <script src="../../assets/js/bootstrap-typeahead.js"></script> 
  <script src="../../assets/js/application.js"></script>  
 </body>
</html>